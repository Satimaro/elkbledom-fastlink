name: Build ZIP and Create Release (auto version + HACS)

on:
  workflow_dispatch:

jobs:
  build-and-release:
    name: Auto Version + HACS Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt || true

      # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· manifest.json
      - name: Get current version
        id: get_version
        run: |
          CURRENT=$(grep '"version"' custom_components/elkbledom_fastlink/manifest.json | cut -d '"' -f4)
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT"

      # Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ patch (x.y.z â†’ x.y.(z+1))
      - name: Bump version
        id: bump_version
        run: |
          IFS='.' read -r MAJOR MINOR PATCH <<< "${{ steps.get_version.outputs.current }}"
          PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ”¼ New version: $NEW_VERSION"

      # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ manifest.json
      - name: Update manifest.json
        run: |
          sed -i 's/"version": ".*"/"version": "${{ steps.bump_version.outputs.new_version }}"/' custom_components/elkbledom_fastlink/manifest.json
          echo "âœ… Updated manifest.json to version ${{ steps.bump_version.outputs.new_version }}"

      # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ .hacs.json
      - name: Update .hacs.json
        run: |
          cat > .hacs.json <<EOF
          {
            "name": "ELK-BLEDOM FastLink",
            "content_in_root": false,
            "filename": "elkbledom_fastlink.zip",
            "render_readme": true,
            "zip_release": true,
            "homeassistant": "2023.0.0",
            "version": "${{ steps.bump_version.outputs.new_version }}",
            "resources": [],
            "iot_class": "local_push"
          }
          EOF
          echo "âœ… Updated .hacs.json for HACS compatibility"

      # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð°Ñ€Ñ…Ð¸Ð² Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð°
      - name: Prepare release ZIP
        run: |
          mkdir -p elkbledom_fastlink
          cp -r custom_components/elkbledom_fastlink elkbledom_fastlink/custom_components
          zip -r elkbledom_fastlink.zip elkbledom_fastlink
          echo "âœ… ZIP file created: elkbledom_fastlink.zip"

      # ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ð¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
      - name: Commit and push updates
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add custom_components/elkbledom_fastlink/manifest.json .hacs.json
          git commit -m "ðŸ”– Bump version to ${{ steps.bump_version.outputs.new_version }} and update HACS metadata"
          git push

      # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ñ€ÐµÐ»Ð¸Ð· Ð¸ Ñ‚ÐµÐ³
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bump_version.outputs.new_version }}
          name: "ELK-BLEDOM FastLink v${{ steps.bump_version.outputs.new_version }}"
          body: |
            ðŸš€ **Release ELK-BLEDOM FastLink v${{ steps.bump_version.outputs.new_version }}**
            
            ðŸ”§ **Changes:**
            â€¢ Improved brightness control  
            â€¢ Optimized color and warm tone  
            â€¢ Restored effect animations  
            â€¢ Enhanced Bluetooth stability  
            
            ---
            ðŸ§© Home Assistant custom integration for ELK-BLEDOM RGB controllers  
            ðŸ’¾ Fully compatible with HACS  
            ðŸ”— https://github.com/Satimaro/elkbledom-fastlink
          files: |
            elkbledom_fastlink.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
